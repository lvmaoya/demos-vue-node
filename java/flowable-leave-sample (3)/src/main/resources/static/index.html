<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>请假流程管理</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .card-role { margin-bottom: 20px; }
  .status-pending { color: orange; font-weight: bold; }
  .status-approved { color: green; font-weight: bold; }
  .status-rejected { color: red; font-weight: bold; }
</style>
<script>
const BASE_URL = "http://localhost:8080/leave";

// 公共 fetch 封装，自动处理非 JSON 响应
async function request(url, options = {}) {
    const res = await fetch(BASE_URL + url, options);
    const text = await res.text();
    if (!text) return []; // 空响应返回空数组
    try {
        return JSON.parse(text);
    } catch (e) {
        console.error("Failed to parse JSON:", text);
        return [];
    }
}

// 用户提交请假
async function applyLeave(userId) {
    const days = document.getElementById(`${userId}-days`).value;
    const reason = document.getElementById(`${userId}-reason`).value;
    const data = { userId, days: parseInt(days), reason };
    await request("/apply", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    });
    await loadAll(); // 提交后刷新所有相关内容
}

// 加载用户请假记录
async function loadUserRequests(userId) {
    const list = await request(`/my-requests?userId=${userId}`);
    const container = document.getElementById(`${userId}-requests`);
    container.innerHTML = "";
    if (list.length === 0) {
        container.innerHTML = "<div class='text-muted'>暂无记录</div>";
        return;
    }
    list.forEach(r => {
        const div = document.createElement("div");
        div.className = "card p-2 mb-2";
        let statusClass = r.status === "待审批" ? "status-pending" :
                          r.status === "已同意" ? "status-approved" : "status-rejected";
        div.innerHTML = `请假天数: ${r.days}, 原因: ${r.reason}, <span class="${statusClass}">状态: ${r.status}</span>`;
        container.appendChild(div);
    });
}

// 加载角色任务
async function loadTasks(role) {
    const list = await request(`/tasks?assignee=${role}`);
    const container = document.getElementById(`${role}-tasks`);
    container.innerHTML = "";
    if (list.length === 0) {
        container.innerHTML = "<div class='text-muted'>暂无任务</div>";
        return;
    }
    list.forEach(t => {
        const div = document.createElement("div");
        div.className = "card p-2 mb-2";
        div.innerHTML = `
            <b>${t.name}</b> (申请人: ${t.startUserId}) <br>
            天数: ${t.days}, 原因: ${t.reason} <br>
            <button class="btn btn-success btn-sm me-1" onclick="completeTask('${t.id}', true, '${role}')">同意</button>
            <button class="btn btn-danger btn-sm" onclick="completeTask('${t.id}', false, '${role}')">拒绝</button>
        `;
        container.appendChild(div);
    });
}

// 完成任务
async function completeTask(taskId, approved, role) {
    await request(`/tasks/${taskId}/complete?approved=${approved}`, { method: "POST" });
    await loadAll(); // 审批完成后刷新所有相关内容
}

// 加载管理员查看所有流程
async function loadAllProcesses() {
    const list = await request("/processes");
    const container = document.getElementById("admin-processes");
    container.innerHTML = "";
    if (list.length === 0) {
        container.innerHTML = "<div class='text-muted'>暂无流程</div>";
        return;
    }
    list.forEach(p => {
        const div = document.createElement("div");
        div.className = "card p-2 mb-2";
        div.innerHTML = `流程ID: ${p.id}, 申请人: ${p.startUserId}, 天数: ${p.days}, 原因: ${p.reason}, 状态: ${p.status}`;
        container.appendChild(div);
    });
}

// 刷新所有板块
async function loadAll() {
    await Promise.all([
        loadUserRequests("user1"),
        loadUserRequests("user2"),
        loadTasks("manager"),
        loadTasks("hr"),
        loadAllProcesses()
    ]);
}

// 自动刷新（每5秒）
setInterval(loadAll, 5000);

window.onload = loadAll;
</script>
</head>
<body class="p-4">
<div class="container">
    <h1 class="mb-4">请假流程管理</h1>
    <div class="row">
        <!-- 用户区 -->
        <div class="col-md-6">
            <div class="card card-role p-3 border-primary">
                <h4 class="text-primary">用户1提交请假</h4>
                <input id="user1-days" type="number" class="form-control mb-2" placeholder="请假天数">
                <input id="user1-reason" type="text" class="form-control mb-2" placeholder="请假原因">
                <button class="btn btn-primary" onclick="applyLeave('user1')">提交</button>
                <h5 class="mt-3">我的请假记录</h5>
                <div id="user1-requests"></div>
            </div>

            <div class="card card-role p-3 border-primary">
                <h4 class="text-primary">用户2提交请假</h4>
                <input id="user2-days" type="number" class="form-control mb-2" placeholder="请假天数">
                <input id="user2-reason" type="text" class="form-control mb-2" placeholder="请假原因">
                <button class="btn btn-primary" onclick="applyLeave('user2')">提交</button>
                <h5 class="mt-3">我的请假记录</h5>
                <div id="user2-requests"></div>
            </div>
        </div>

        <!-- 审批与管理员区 -->
        <div class="col-md-6">
            <div class="card card-role p-3 border-warning">
                <h4 class="text-warning">经理待办任务</h4>
                <div id="manager-tasks"></div>
            </div>

            <div class="card card-role p-3 border-success">
                <h4 class="text-success">HR待办任务</h4>
                <div id="hr-tasks"></div>
            </div>

            <div class="card card-role p-3 border-secondary">
                <h4 class="text-secondary">管理员查看所有流程</h4>
                <div id="admin-processes"></div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
